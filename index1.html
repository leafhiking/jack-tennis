<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jack's All-Star Tennis Camp (Audio)</title>
    <!-- 引入 React 和 Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #0f172a; color: white; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        .selected-ring { ring: 4px solid white; ring-offset: 2px; ring-offset-color: #0f172a; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .6; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Data: Coaches ---
        const COACHES = {
            Rafa: { color: "yellow", bg: "bg-yellow-500", text: "text-yellow-500", border: "border-yellow-500" },
            Carlos: { color: "green", bg: "bg-green-500", text: "text-green-500", border: "border-green-500" },
            Jannik: { color: "orange", bg: "bg-orange-500", text: "text-orange-500", border: "border-orange-500" }
        };

        // --- Component: Calendar ---
        const TrainingCalendar = ({ triggerUpdate }) => {
            const [history, setHistory] = useState([]);
            const [todayStr, setTodayStr] = useState("");

            useEffect(() => {
                const now = new Date();
                const str = now.toISOString().split('T')[0]; // YYYY-MM-DD
                setTodayStr(str);
                
                // 读取历史
                const saved = JSON.parse(localStorage.getItem('jack_tennis_history') || '[]');
                setHistory(saved);
            }, [triggerUpdate]); // triggerUpdate 变动时刷新（打卡后）

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay(); 
            const monthName = now.toLocaleString('default', { month: 'long' });

            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-8 w-8"></div>);

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                let statusClass = "bg-gray-800 text-gray-500 border border-gray-700"; 
                
                if (history.includes(dateStr)) {
                    statusClass = "bg-green-500 text-white font-bold shadow-lg shadow-green-500/30 border-none";
                } else if (dateStr < todayStr) {
                    statusClass = "bg-red-900/30 text-red-500 border border-red-900/50";
                } else if (dateStr === todayStr) {
                    statusClass = "bg-gray-700 text-white border-2 border-white";
                }

                days.push(
                    <div key={d} className={`h-8 w-8 rounded-full flex items-center justify-center text-xs transition-all ${statusClass}`}>
                        {d}
                    </div>
                );
            }

            return (
                <div className="w-full max-w-sm bg-gray-900/50 rounded-xl p-4 mt-8 border border-gray-800">
                    <h3 className="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4 flex justify-between px-1">
                        <span>{monthName} Streak</span>
                        <span className="text-white">{history.length} Days</span>
                    </h3>
                    <div className="grid grid-cols-7 gap-2 justify-items-center">
                        {['S','M','T','W','T','F','S'].map(d => <div key={d} className="text-[10px] text-gray-600 font-bold mb-1">{d}</div>)}
                        {days}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [coach, setCoach] = useState('Rafa');
            const [session, setSession] = useState('A');
            const [isPlaying, setIsPlaying] = useState(false);
            const [audioError, setAudioError] = useState("");
            const [updateCal, setUpdateCal] = useState(0); // 用于触发日历刷新
            
            const audioRef = useRef(null);

            // 切换教练或课程时重置播放器
            useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                    setIsPlaying(false);
                    setAudioError("");
                }
            }, [coach, session]);

            const handlePlay = () => {
                if (!audioRef.current) return;

                if (isPlaying) {
                    audioRef.current.pause();
                    setIsPlaying(false);
                } else {
                    // 构建文件名: audio/Session_A_Rafa.mp3
                    const fileName = `audio/Session_${session}_${coach}.mp3`;
                    audioRef.current.src = fileName;
                    
                    audioRef.current.play()
                        .then(() => {
                            setIsPlaying(true);
                            setAudioError("");
                            // --- 打卡逻辑 ---
                            const now = new Date().toISOString().split('T')[0];
                            const history = JSON.parse(localStorage.getItem('jack_tennis_history') || '[]');
                            if (!history.includes(now)) {
                                history.push(now);
                                localStorage.setItem('jack_tennis_history', JSON.stringify(history));
                                setUpdateCal(prev => prev + 1); // 刷新日历
                            }
                        })
                        .catch(e => {
                            console.error(e);
                            setIsPlaying(false);
                            setAudioError(`Could not find file: ${fileName}`);
                        });
                }
            };

            const activeColor = COACHES[coach];

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 font-sans">
                    
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-black italic tracking-tighter text-white">
                            JACK'S <span className={activeColor.text}>D1</span> CAMP
                        </h1>
                        <p className="text-gray-400 text-sm mt-1">Audio Training Player</p>
                    </div>

                    {/* 1. Coach Selection */}
                    <div className="w-full max-w-md mb-6">
                        <label className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 block">Coach</label>
                        <div className="grid grid-cols-3 gap-3">
                            {Object.keys(COACHES).map(c => (
                                <button 
                                    key={c}
                                    onClick={() => setCoach(c)}
                                    className={`p-3 rounded-xl border-2 flex flex-col items-center gap-2 btn-press transition-all ${coach === c ? `${COACHES[c].bg} border-white text-black` : 'bg-gray-800 border-gray-700 text-gray-400'}`}
                                >
                                    <div className="text-xl font-bold">{c[0]}</div>
                                    <span className="text-xs font-bold uppercase">{c}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* 2. Session Selection */}
                    <div className="w-full max-w-md mb-8">
                        <label className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 block">Session</label>
                        <div className="grid grid-cols-2 gap-3">
                            {['A', 'B'].map(s => (
                                <button 
                                    key={s}
                                    onClick={() => setSession(s)}
                                    className={`p-4 rounded-xl border-2 text-left btn-press transition-all ${session === s ? 'border-white bg-gray-700' : 'border-gray-800 bg-gray-800 opacity-60'}`}
                                >
                                    <div className="text-2xl font-black">Session {s}</div>
                                    <div className="text-xs text-gray-400">{s === 'A' ? 'Leg Endurance' : 'Fast Feet'}</div>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* 3. Player Control */}
                    <div className="w-full max-w-md">
                        {audioError && (
                            <div className="mb-4 p-3 bg-red-900/50 border border-red-500 rounded-lg text-red-200 text-xs text-center">
                                <i className="fas fa-exclamation-circle mr-1"></i> {audioError}
                                <br/>Please ensure mp3 files are in the "audio" folder.
                            </div>
                        )}

                        <button 
                            onClick={handlePlay}
                            className={`w-full py-6 rounded-2xl shadow-2xl btn-press flex items-center justify-center gap-3 transition-all ${isPlaying ? 'bg-red-500 text-white' : 'bg-white text-black'}`}
                        >
                            <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'} text-3xl`}></i>
                            <span className="text-2xl font-black italic tracking-wide">{isPlaying ? 'PAUSE' : 'START TRAINING'}</span>
                        </button>
                        
                        {isPlaying && (
                            <div className="mt-4 text-center text-gray-500 text-xs animate-pulse-slow">
                                Playing: Session {session} ({coach})
                            </div>
                        )}
                        
                        <audio ref={audioRef} onEnded={() => setIsPlaying(false)} />
                    </div>

                    {/* 4. Calendar */}
                    <TrainingCalendar triggerUpdate={updateCal} />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
