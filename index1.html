<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jack's D1 Tennis Trainer (Calendar)</title>
    <!-- 使用 CDN 库 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #0f172a; color: white; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        .visual-frame {
            width: 100%;
            height: 320px;
            background: #1e293b;
            border-radius: 1rem;
            overflow: hidden;
            border: 2px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .visual-frame img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
        }

        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .6; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Audio Logic ---
        let audioCtx;
        const initAudio = () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        };

        const playBeep = (freq = 800, duration = 0.1) => {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.frequency.value = freq;
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                osc.start();
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) { console.error(e); }
        };

        // --- Data: 引用本地 assets ---
        const VISUALS = {
            warmup: "./assets/warmup.gif",
            jacks: "./assets/jacks.gif",
            highknees: "./assets/highknees.gif",
            squat: "./assets/squat.gif",
            lunge: "./assets/lunge.gif",
            plank: "./assets/plank.gif", 
            climber: "./assets/climber.gif",
            skater: "./assets/skater.gif", 
            rdl: "./assets/rdl.gif", 
            run: "./assets/run.gif"
        };

        const SESSIONS = {
            A: {
                name: "Leg Endurance",
                description: "Build the tank for the 3rd set.",
                warmup: [
                    { name: "Joint Rotations", type: "timer", duration: 60, gif: VISUALS.warmup, text: "Joint Rotations. Ankles and knees." },
                    { name: "Jumping Jacks", type: "timer", duration: 60, gif: VISUALS.jacks, text: "Jumping Jacks. Wake up the body." },
                    { name: "High Knees", type: "timer", duration: 30, gif: VISUALS.highknees, text: "High Knees. Explosive!" }
                ],
                circuit: [
                    { name: "Bodyweight Squats", type: "squat_reps", count: 20, gif: VISUALS.squat, text: "Squats. Perfect form." },
                    { name: "Reverse Lunges", type: "reps", count: 20, interval: 3.0, gif: VISUALS.lunge, text: "Reverse Lunges. Knee close to floor." },
                    { name: "Wall Sit", type: "timer", duration: 60, gif: VISUALS.squat, text: "Wall Sit. Fight the burn." }, 
                    { name: "Plank", type: "timer", duration: 45, gif: VISUALS.plank, text: "Plank. Core tight." }
                ]
            },
            B: {
                name: "Fast Feet",
                description: "Speed & Agility for Division 1.",
                warmup: [
                    { name: "Joint Rotations", type: "timer", duration: 60, gif: VISUALS.warmup, text: "Joint Rotations." },
                    { name: "Fast Feet", type: "timer", duration: 60, gif: VISUALS.run, text: "Fast Feet in place." },
                    { name: "High Knees", type: "timer", duration: 30, gif: VISUALS.highknees, text: "High Knees. Fast!" }
                ],
                circuit: [
                    { name: "Skater Hops", type: "reps", count: 20, interval: 1.5, gif: VISUALS.skater, text: "Skater Hops. Explode Side to Side." },
                    { name: "Line Hops", type: "timer", duration: 30, gif: VISUALS.highknees, text: "Line Hops. Hot floor!" },
                    { name: "Mountain Climbers", type: "timer", duration: 30, gif: VISUALS.climber, text: "Mountain Climbers. Drive." },
                    { name: "Single Leg RDL", type: "reps", count: 16, interval: 4.0, gif: VISUALS.rdl, text: "Single Leg RDL. Balance." }
                ]
            }
        };

        const COACH_PERSONAS = {
            nadal: {
                name: "Rafa",
                color: "text-yellow-400",
                bg: "bg-yellow-400",
                border: "border-yellow-400",
                intro: "Hola Jack. It is Rafa. Dreams are built in the morning. Let's work.",
                rest: "Breathe. The pain tells you you are alive. Do not quit.",
                outro: "Unbelievable effort. You conquered the morning. Vamos!",
                encouragement: ["Vamos!", "Suffer!", "Fight!", "No excuses!"],
                defaultVoiceId: "ErXwobaYiN019PkySvjV"
            },
            alcaraz: {
                name: "Carlitos",
                color: "text-green-400",
                bg: "bg-green-400",
                border: "border-green-400",
                intro: "Hey Jack! We play with joy, but work with fire! Let's go!",
                rest: "Smile Jack! Energy up! Fast recovery.",
                outro: "Yes! That was amazing energy. You are getting faster!",
                encouragement: ["Energy!", "Faster!", "Disfruta!", "Explode!"],
                defaultVoiceId: "ErXwobaYiN019PkySvjV"
            },
            sinner: {
                name: "Jannik",
                color: "text-orange-400",
                bg: "bg-orange-400",
                border: "border-orange-400",
                intro: "Hi Jack. Precision and control. Let's build the perfect player.",
                rest: "Stay cold. Heart rate down. Visualize.",
                outro: "Good work. Clean execution. That is the standard.",
                encouragement: ["Focus.", "Control.", "Push.", "Stay solid."],
                defaultVoiceId: "ErXwobaYiN019PkySvjV"
            }
        };

        // --- NEW: Calendar Component ---
        const TrainingCalendar = () => {
            const [history, setHistory] = useState([]);
            const [todayStr, setTodayStr] = useState("");

            useEffect(() => {
                // 1. 获取今天日期 YYYY-MM-DD
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const str = `${year}-${month}-${day}`;
                setTodayStr(str);

                // 2. 读取历史记录
                const saved = JSON.parse(localStorage.getItem('jack_tennis_history') || '[]');
                
                // 3. 自动打卡：只要打开 App 就记录今天
                // (如果想严格一点，可以把这步移到 workout finish 时)
                let newHistory = saved;
                if (!saved.includes(str)) {
                    newHistory = [...saved, str];
                    localStorage.setItem('jack_tennis_history', JSON.stringify(newHistory));
                }
                setHistory(newHistory);
            }, []);

            // 日历逻辑
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay(); // 0 is Sunday
            const monthName = now.toLocaleString('default', { month: 'long' });

            const days = [];
            // 填充前面的空白
            for (let i = 0; i < firstDay; i++) {
                days.push(<div key={`empty-${i}`} className="h-8 w-8"></div>);
            }

            // 填充日期
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                
                let statusClass = "bg-gray-700 text-gray-500"; // 默认为灰色（未来）
                
                if (dateStr === todayStr) {
                    statusClass = "bg-green-500 text-white ring-2 ring-white font-black shadow-lg shadow-green-500/50"; // 今天 (已打卡)
                } else if (dateStr < todayStr) {
                    if (history.includes(dateStr)) {
                        statusClass = "bg-green-500 text-white"; // 过去已完成
                    } else {
                        statusClass = "bg-red-500 text-white opacity-40"; // 过去缺席
                    }
                }

                days.push(
                    <div key={d} className={`h-8 w-8 rounded-full flex items-center justify-center text-xs font-bold transition-all ${statusClass}`}>
                        {d}
                    </div>
                );
            }

            return (
                <div className="w-full max-w-sm bg-gray-800 rounded-xl p-4 mt-6 border border-gray-700">
                    <h3 className="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4 text-center flex justify-between px-2">
                        <span>{monthName} Streak</span>
                        <span>{history.length} Days</span>
                    </h3>
                    <div className="grid grid-cols-7 gap-2 justify-items-center">
                        {['S','M','T','W','T','F','S'].map(d => (
                            <div key={d} className="text-xs text-gray-500 font-bold mb-1">{d}</div>
                        ))}
                        {days}
                    </div>
                    <div className="mt-4 flex justify-center gap-4 text-[10px] text-gray-400 uppercase tracking-wider">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-green-500"></div> Done</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500 opacity-40"></div> Missed</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-gray-700"></div> Future</div>
                    </div>
                </div>
            );
        };

        // --- Components ---

        const SetupScreen = ({ onStart, settings, setSettings }) => {
            const [localSettings, setLocalSettings] = useState(settings);

            const handleChange = (field, value) => {
                const newSettings = { ...localSettings, [field]: value };
                setLocalSettings(newSettings);
            };

            return (
                <div className="min-h-screen p-6 flex flex-col items-center justify-center space-y-6 max-w-md mx-auto w-full">
                    <div className="text-center space-y-2 w-full">
                        <h1 className="text-4xl font-black italic tracking-tighter text-white">JACK'S <span className="text-yellow-400">D1</span> TRAINER</h1>
                        <p className="text-gray-400 text-sm font-medium">Pro Tennis Conditioning</p>
                    </div>

                    <div className="space-y-3 w-full">
                        <label className="text-xs font-bold text-gray-500 uppercase tracking-widest">Select Coach</label>
                        <div className="grid grid-cols-3 gap-3">
                            {Object.keys(COACH_PERSONAS).map(key => (
                                <button 
                                    key={key}
                                    onClick={() => handleChange('coach', key)}
                                    className={`p-3 rounded-xl border-2 flex flex-col items-center gap-2 btn-press ${localSettings.coach === key ? `${COACH_PERSONAS[key].border} bg-gray-800` : 'border-gray-800 bg-gray-900'}`}
                                >
                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold bg-gray-800 ${COACH_PERSONAS[key].color}`}>
                                        {COACH_PERSONAS[key].name[0]}
                                    </div>
                                    <span className={`text-sm font-bold ${localSettings.coach === key ? 'text-white' : 'text-gray-500'}`}>{COACH_PERSONAS[key].name}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="space-y-3 w-full">
                        <label className="text-xs font-bold text-gray-500 uppercase tracking-widest">Select Workout</label>
                        <div className="space-y-2">
                            {Object.keys(SESSIONS).map(key => (
                                <button 
                                    key={key}
                                    onClick={() => handleChange('session', key)}
                                    className={`w-full p-4 rounded-xl border-2 text-left btn-press flex justify-between items-center ${localSettings.session === key ? 'border-white bg-gray-800' : 'border-gray-800 bg-gray-900'}`}
                                >
                                    <div>
                                        <div className="font-bold text-lg text-white">{SESSIONS[key].name}</div>
                                        <div className="text-xs text-gray-400">{SESSIONS[key].description}</div>
                                    </div>
                                    {localSettings.session === key && <i className="fas fa-check-circle text-green-400 text-xl"></i>}
                                </button>
                            ))}
                        </div>
                    </div>

                    <button 
                        onClick={() => { setSettings(localSettings); initAudio(); onStart(); }}
                        className="w-full py-4 bg-white text-black font-black text-xl rounded-xl shadow-lg hover:bg-gray-200 btn-press uppercase tracking-wide flex items-center justify-center gap-2"
                    >
                        <i className="fas fa-play"></i> Start Training
                    </button>

                    {/* 日历组件放在最后 */}
                    <TrainingCalendar />
                </div>
            );
        };

        const ExerciseVisual = ({ gifSrc, isActive }) => {
            return (
                <div className="visual-frame relative group">
                    {gifSrc ? (
                        <img 
                            src={gifSrc} 
                            alt="Exercise Demo" 
                            className={`transition-opacity duration-500 ${isActive ? 'opacity-100' : 'opacity-40 grayscale'}`}
                            onError={(e) => {e.target.style.display='none'; e.target.parentNode.innerHTML += '<div class="text-red-500 font-bold">Image Missing<br/><span class="text-xs font-normal text-gray-400">Check assets folder</span></div>'}}
                        />
                    ) : (
                        <div className="text-gray-500">No Visual</div>
                    )}
                    
                    {!isActive && (
                        <div className="absolute inset-0 flex items-center justify-center">
                            <div className="bg-black/50 p-4 rounded-full backdrop-blur-sm border border-gray-500">
                                <i className="fas fa-pause text-white text-2xl"></i>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const WorkoutScreen = ({ settings, onFinish }) => {
            const [queue, setQueue] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [timeLeft, setTimeLeft] = useState(0);
            const [repCount, setRepCount] = useState(0);
            const [visualText, setVisualText] = useState("");
            const [audioCache, setAudioCache] = useState({});

            const coach = COACH_PERSONAS[settings.coach];
            const session = SESSIONS[settings.session];
            const voiceId = settings.voiceIds[settings.coach] || coach.defaultVoiceId;

            const playAudio = async (text) => {
                if (!text) return;
                
                if (audioCache[text]) {
                    return new Promise(resolve => {
                        const audio = new Audio(audioCache[text]);
                        audio.onended = resolve;
                        audio.play().catch(resolve);
                    });
                }

                if (settings.apiKey) {
                    try {
                        const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                            method: 'POST',
                            headers: { 'xi-api-key': settings.apiKey, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text, model_id: "eleven_multilingual_v2", voice_settings: { stability: 0.35, similarity_boost: 0.8 } })
                        });
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            setAudioCache(prev => ({...prev, [text]: url}));
                            return new Promise(resolve => {
                                const audio = new Audio(url);
                                audio.onended = resolve;
                                audio.play().catch(resolve);
                            });
                        }
                    } catch(e) { console.error(e); }
                }
                
                return new Promise(resolve => {
                    const u = new SpeechSynthesisUtterance(text);
                    u.rate = 1.2;
                    u.onend = resolve;
                    u.onerror = resolve; 
                    window.speechSynthesis.speak(u);
                });
            };

            useEffect(() => {
                const q = [];
                q.push({ type: 'speak', text: coach.intro });
                q.push({ type: 'speak', text: "Warm Up Phase." });
                
                session.warmup.forEach(ex => {
                    q.push({ type: 'speak', text: ex.text, gif: ex.gif });
                    q.push({ ...ex, isWarmup: true });
                });
                
                for (let r = 1; r <= 3; r++) {
                    q.push({ type: 'speak', text: `Round ${r}. Get Ready.` });
                    session.circuit.forEach(ex => {
                        q.push({ type: 'speak', text: ex.text, gif: ex.gif });
                        q.push({ ...ex, round: r });
                        q.push({ type: 'speak', text: "Stop." });
                    });
                    
                    if (r < 3) {
                        q.push({ type: 'speak', text: coach.rest });
                        q.push({ type: 'rest', duration: 90 });
                    }
                }
                
                q.push({ type: 'speak', text: coach.outro });
                q.push({ type: 'finish' });
                
                setQueue(q);
                setTimeout(() => processQueue(0, q), 500);
            }, []);

            const processQueue = async (index, q) => {
                if (index >= q.length) return;
                setCurrentIndex(index);
                const step = q[index];

                setVisualText(step.text || (step.type === 'rest' ? 'REST' : step.name));

                if (step.type === 'speak') {
                    await playAudio(step.text);
                    processQueue(index + 1, q);
                } else if (step.type === 'timer' || step.type === 'rest') {
                    runTimer(step.duration, () => processQueue(index + 1, q));
                } else if (step.type === 'reps') {
                    runReps(step.count, step.interval, () => processQueue(index + 1, q));
                } else if (step.type === 'squat_reps') {
                    runSquats(step.count, () => processQueue(index + 1, q));
                } else if (step.type === 'finish') {
                    onFinish();
                }
            };

            const runTimer = (sec, cb) => {
                let current = sec;
                setTimeLeft(current);
                const int = setInterval(() => {
                    current--;
                    setTimeLeft(current);
                    if (current > 5) {
                        playBeep(800, 0.05);
                        if (sec >= 45 && current === 30) playAudio("Focus.");
                    } else if (current > 0) {
                        playAudio(String(current));
                    } else {
                        clearInterval(int);
                        playAudio("Stop").then(cb);
                    }
                }, 1000);
            };

            const runReps = async (count, interval, cb) => {
                setRepCount(0);
                for (let i = 1; i <= count; i++) {
                    setRepCount(i);
                    playAudio(String(i));
                    await new Promise(r => setTimeout(r, interval * 1000));
                    if (i === 10 || i === 15) {
                         const p = coach.encouragement[Math.floor(Math.random() * coach.encouragement.length)];
                         await playAudio(p);
                    }
                }
                cb();
            };

            const runSquats = async (count, cb) => {
                setRepCount(0);
                for (let i = 1; i <= count; i++) {
                    setRepCount(i);
                    playAudio(String(i)); await new Promise(r => setTimeout(r, 500));
                    setVisualText("DOWN"); playAudio("Down"); await new Promise(r => setTimeout(r, 1500));
                    setVisualText("UP"); playAudio("Up"); await new Promise(r => setTimeout(r, 1000));
                    if (i === 15) await playAudio("Come on!");
                }
                cb();
            };

            const currentStep = queue[currentIndex] || {};
            const isRest = currentStep.type === 'rest';
            const showVisual = (currentStep.gif && !isRest) && currentStep.type !== 'finish';

            return (
                <div className={`h-screen flex flex-col ${isRest ? 'bg-blue-900' : 'bg-gray-900'} transition-colors duration-500 text-white`}>
                    
                    <div className="flex-1 p-4 flex flex-col justify-center max-h-[50vh]">
                        {showVisual ? (
                            <ExerciseVisual gifSrc={currentStep.gif} isActive={true} />
                        ) : (
                            <div className="flex flex-col items-center justify-center space-y-4 animate-pulse-slow">
                                <div className={`w-32 h-32 rounded-full flex items-center justify-center text-6xl border-4 border-white ${coach.bg} text-black shadow-xl`}>
                                    {coach.name[0]}
                                </div>
                                <div className="text-2xl font-bold tracking-widest uppercase flex items-center gap-2">
                                     <i className={`fas ${isRest ? "fa-clock" : "fa-volume-up"}`}></i>
                                     {isRest ? "Recover" : "Listen"}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="bg-gray-800 p-6 rounded-t-3xl shadow-2xl space-y-6 flex-1 flex flex-col justify-between">
                        <div className="text-center">
                            <h2 className="text-3xl font-black uppercase text-white truncate leading-tight">
                                {currentStep.name || (isRest ? "REST TIME" : "Get Ready")}
                            </h2>
                            <p className={`text-xl font-bold font-mono mt-2 h-8 ${isRest ? 'text-blue-400' : coach.color}`}>
                                {visualText === "DOWN" || visualText === "UP" ? visualText : ""}
                            </p>
                        </div>

                        <div className="flex justify-center items-end space-x-2">
                             <div className="text-8xl font-black font-mono leading-none">
                                {currentStep.type === 'timer' || currentStep.type === 'rest' ? timeLeft : repCount}
                             </div>
                             <div className="text-lg font-bold text-gray-500 mb-4 uppercase">
                                {currentStep.type === 'timer' || currentStep.type === 'rest' ? "Sec" : "Reps"}
                             </div>
                        </div>

                        <div className="space-y-1 pb-4">
                            <div className="flex justify-between text-xs font-bold text-gray-500 uppercase">
                                <span>Progress</span>
                                <span>{Math.round((currentIndex / queue.length) * 100)}%</span>
                            </div>
                            <div className="h-3 bg-gray-700 rounded-full overflow-hidden">
                                <div 
                                    className={`h-full ${isRest ? 'bg-blue-400' : coach.bg} transition-all duration-500`}
                                    style={{width: `${(currentIndex / queue.length) * 100}%`}}
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [settings, setSettings] = useState(() => {
                try {
                    const saved = localStorage.getItem('jack_tennis_settings');
                    return saved ? JSON.parse(saved) : { coach: 'nadal', session: 'A', apiKey: '', voiceIds: {} };
                } catch (e) {
                    return { coach: 'nadal', session: 'A', apiKey: '', voiceIds: {} };
                }
            });
            const [mode, setMode] = useState('setup');

            return (
                <div className="bg-black min-h-screen font-sans selection:bg-yellow-400 selection:text-black">
                    {mode === 'setup' && <SetupScreen settings={settings} setSettings={setSettings} onStart={() => setMode('workout')} />}
                    {mode === 'workout' && <WorkoutScreen settings={settings} onFinish={() => setMode('setup')} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
